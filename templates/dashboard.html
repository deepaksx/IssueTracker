{% extends "base.html" %}

{% block title %}Dashboard - EFI IT Issue Tracker{% endblock %}

{% block content %}
<div class="page-header mb-2">
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
</div>

<!-- KPI Cards -->
<div class="row g-2 mb-2">
    <!-- Total Issues -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-primary kpi-card-clickable" onclick="window.location.href='{{ url_for('tracker') }}'">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Total Issues</h6>
                        <h2 class="card-title mb-0">{{ kpi.total_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-list-ul"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Not Started Issues -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-danger kpi-card-clickable" onclick="window.location.href='{{ url_for('tracker', status='Not Started') }}'">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Not Started</h6>
                        <h2 class="card-title mb-0">{{ kpi.open_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-exclamation-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- In Progress -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-warning kpi-card-clickable" onclick="window.location.href='{{ url_for('tracker', status='In Progress') }}'">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">In Progress</h6>
                        <h2 class="card-title mb-0">{{ kpi.in_progress_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resolved -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-success kpi-card-clickable" onclick="window.location.href='{{ url_for('tracker', status='Resolved') }}'">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Resolved</h6>
                        <h2 class="card-title mb-0">{{ kpi.resolved_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-2 mb-2">
    <!-- Issue Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Issue Status Distribution</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="statusChart" height="140"></canvas>
            </div>
        </div>
    </div>

    <!-- Priority Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Priority Distribution</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="priorityChart" height="140"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-2 mb-2">
    <!-- Category Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Category Distribution</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="categoryChart" height="140"></canvas>
            </div>
        </div>
    </div>

    <!-- Issues by Company -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Issues by Company</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="companyChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row g-2">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <strong class="me-2"><i class="bi bi-lightning"></i> Quick Actions:</strong>
                    <a href="{{ url_for('tracker') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-list-ul"></i> View All Issues
                    </a>
                    <a href="{{ url_for('tracker', status='Not Started') }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-exclamation-circle"></i> View Not Started Issues
                    </a>
                    {% if current_user.is_admin() or current_user.is_hod() %}
                    <a href="{{ url_for('add_issue') }}" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-plus-circle"></i> Add New Issue
                    </a>
                    {% endif %}
                    <a href="{{ url_for('export_csv') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.kpi-card {
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    height: 100%;
}

.kpi-card-clickable {
    cursor: pointer;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.kpi-card .card-body {
    padding: 0.75rem 1rem;
}

.kpi-card-primary {
    border-left: 3px solid #3B82F6;
}

.kpi-card-danger {
    border-left: 3px solid #EF4444;
}

.kpi-card-warning {
    border-left: 3px solid #F59E0B;
}

.kpi-card-success {
    border-left: 3px solid #10B981;
}

.kpi-card .card-subtitle {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 0.25rem !important;
}

.kpi-card .card-title {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0 !important;
}

.kpi-icon {
    font-size: 2rem;
    opacity: 0.2;
    line-height: 1;
}

.kpi-card-primary .kpi-icon {
    color: #3B82F6;
}

.kpi-card-danger .kpi-icon {
    color: #EF4444;
}

.kpi-card-warning .kpi-icon {
    color: #F59E0B;
}

.kpi-card-success .kpi-icon {
    color: #10B981;
}

.card .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.5rem 0.75rem;
}

.card .card-header h5 {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
}

.card .card-body {
    padding: 0.75rem;
}

.page-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.page-header {
    padding: 0.5rem 0;
}

/* Compact chart legends */
canvas {
    max-height: 200px;
}

#companyChart {
    max-height: 200px !important;
}

/* Make charts look clickable */
canvas {
    cursor: pointer;
}

.card canvas:hover {
    opacity: 0.9;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Helper function to create gradient
function createGradient(ctx, colorStart, colorEnd) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, colorStart);
    gradient.addColorStop(1, colorEnd);
    return gradient;
}

// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.status_labels | tojson }},
        datasets: [{
            data: {{ chart_data.status_values | tojson }},
            backgroundColor: [
                '#EF4444',  // Not Started - Red
                '#F59E0B',  // In Progress - Amber
                '#10B981'   // Resolved - Green
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12,
                    padding: 8,
                    font: {
                        size: 10
                    }
                }
            }
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const status = {{ chart_data.status_labels | tojson }}[index];
                window.location.href = `/tracker?status=${encodeURIComponent(status)}`;
            }
        }
    }
});

// Priority Distribution Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
const priorityChart = new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.priority_labels | tojson }},
        datasets: [{
            label: 'Issues',
            data: {{ chart_data.priority_values | tojson }},
            backgroundColor: [
                createGradient(priorityCtx, '#34D399', '#059669'),  // Low - Green gradient
                createGradient(priorityCtx, '#FBBF24', '#D97706'),  // Medium - Amber gradient
                createGradient(priorityCtx, '#F87171', '#DC2626'),  // High - Red gradient
                createGradient(priorityCtx, '#DC2626', '#991B1B')   // Critical - Dark Red gradient
            ],
            borderRadius: 4,
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: 10
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        size: 10
                    }
                }
            }
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const priority = {{ chart_data.priority_labels | tojson }}[index];
                window.location.href = `/tracker?priority=${encodeURIComponent(priority)}`;
            }
        }
    }
});

// Category Distribution Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryChart = new Chart(categoryCtx, {
    type: 'pie',
    data: {
        labels: {{ chart_data.category_labels | tojson }},
        datasets: [{
            data: {{ chart_data.category_values | tojson }},
            backgroundColor: [
                '#60A5FA',  // Blue (lighter)
                '#A78BFA',  // Purple (lighter)
                '#34D399',  // Green (lighter)
                '#FBBF24',  // Amber (lighter)
                '#F87171'   // Red (lighter)
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12,
                    padding: 8,
                    font: {
                        size: 10
                    }
                }
            }
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                const category = {{ chart_data.category_labels | tojson }}[index];
                window.location.href = `/tracker?category=${encodeURIComponent(category)}`;
            }
        }
    }
});

// Company Distribution Chart (Stacked by Status)
const companyCtx = document.getElementById('companyChart').getContext('2d');
const companyChart = new Chart(companyCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.company_labels | tojson }},
        datasets: [
            {
                label: 'Not Started',
                data: {{ chart_data.company_not_started | tojson }},
                backgroundColor: createGradient(companyCtx, '#F87171', '#DC2626'),
                borderRadius: 4,
                borderWidth: 0
            },
            {
                label: 'In Progress',
                data: {{ chart_data.company_in_progress | tojson }},
                backgroundColor: createGradient(companyCtx, '#FBBF24', '#D97706'),
                borderRadius: 4,
                borderWidth: 0
            },
            {
                label: 'Resolved',
                data: {{ chart_data.company_resolved | tojson }},
                backgroundColor: createGradient(companyCtx, '#34D399', '#059669'),
                borderRadius: 4,
                borderWidth: 0
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    padding: 6,
                    font: {
                        size: 9
                    }
                },
                onClick: (event, legendItem, legend) => {
                    // Click on legend filters by status
                    const status = legendItem.text;
                    window.location.href = `/tracker?status=${encodeURIComponent(status)}`;
                }
            }
        },
        scales: {
            x: {
                stacked: true,
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: 10
                    }
                }
            },
            y: {
                stacked: true,
                ticks: {
                    font: {
                        size: 11
                    },
                    autoSkip: false
                }
            }
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const companyIndex = elements[0].index;
                const datasetIndex = elements[0].datasetIndex;
                const company = {{ chart_data.company_labels | tojson }}[companyIndex];
                const statuses = ['Not Started', 'In Progress', 'Resolved'];
                const status = statuses[datasetIndex];
                window.location.href = `/tracker?company=${encodeURIComponent(company)}&status=${encodeURIComponent(status)}`;
            }
        }
    }
});
</script>
{% endblock %}
