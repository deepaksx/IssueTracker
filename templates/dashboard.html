{% extends "base.html" %}

{% block title %}Dashboard - EFI IT Issue Tracker{% endblock %}

{% block content %}
<div class="page-header mb-2">
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
</div>

<!-- KPI Cards -->
<div class="row g-2 mb-2">
    <!-- Total Issues -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Total Issues</h6>
                        <h2 class="card-title mb-0">{{ kpi.total_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-list-ul"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Not Started Issues -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Not Started</h6>
                        <h2 class="card-title mb-0">{{ kpi.open_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-exclamation-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- In Progress -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">In Progress</h6>
                        <h2 class="card-title mb-0">{{ kpi.in_progress_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resolved -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Resolved</h6>
                        <h2 class="card-title mb-0">{{ kpi.resolved_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-2 mb-2">
    <!-- Issue Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Issue Status Distribution</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="statusChart" height="140"></canvas>
            </div>
        </div>
    </div>

    <!-- Priority Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Priority Distribution</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="priorityChart" height="140"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-2 mb-2">
    <!-- Category Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Category Distribution</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="categoryChart" height="140"></canvas>
            </div>
        </div>
    </div>

    <!-- Issues by Company -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Issues by Company</h5>
            </div>
            <div class="card-body p-2">
                <canvas id="companyChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row g-2">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <strong class="me-2"><i class="bi bi-lightning"></i> Quick Actions:</strong>
                    <a href="{{ url_for('tracker') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-list-ul"></i> View All Issues
                    </a>
                    <a href="{{ url_for('tracker', status='Not Started') }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-exclamation-circle"></i> View Not Started Issues
                    </a>
                    {% if current_user.is_admin() or current_user.is_hod() %}
                    <a href="{{ url_for('add_issue') }}" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-plus-circle"></i> Add New Issue
                    </a>
                    {% endif %}
                    <a href="{{ url_for('export_csv') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.kpi-card {
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    height: 100%;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.kpi-card .card-body {
    padding: 0.75rem 1rem;
}

.kpi-card-primary {
    border-left: 3px solid #0d6efd;
}

.kpi-card-danger {
    border-left: 3px solid #dc3545;
}

.kpi-card-warning {
    border-left: 3px solid #ffc107;
}

.kpi-card-success {
    border-left: 3px solid #198754;
}

.kpi-card .card-subtitle {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 0.25rem !important;
}

.kpi-card .card-title {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0 !important;
}

.kpi-icon {
    font-size: 2rem;
    opacity: 0.2;
    line-height: 1;
}

.kpi-card-primary .kpi-icon {
    color: #0d6efd;
}

.kpi-card-danger .kpi-icon {
    color: #dc3545;
}

.kpi-card-warning .kpi-icon {
    color: #ffc107;
}

.kpi-card-success .kpi-icon {
    color: #198754;
}

.card .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.5rem 0.75rem;
}

.card .card-header h5 {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
}

.card .card-body {
    padding: 0.75rem;
}

.page-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.page-header {
    padding: 0.5rem 0;
}

/* Compact chart legends */
canvas {
    max-height: 200px;
}

#companyChart {
    max-height: 200px !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.status_labels | tojson }},
        datasets: [{
            data: {{ chart_data.status_values | tojson }},
            backgroundColor: ['#dc3545', '#ffc107', '#198754', '#6c757d']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12,
                    padding: 8,
                    font: {
                        size: 10
                    }
                }
            }
        }
    }
});

// Priority Distribution Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.priority_labels | tojson }},
        datasets: [{
            label: 'Issues',
            data: {{ chart_data.priority_values | tojson }},
            backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: 10
                    }
                }
            },
            x: {
                ticks: {
                    font: {
                        size: 10
                    }
                }
            }
        }
    }
});

// Category Distribution Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'pie',
    data: {
        labels: {{ chart_data.category_labels | tojson }},
        datasets: [{
            data: {{ chart_data.category_values | tojson }},
            backgroundColor: ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#fd7e14']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12,
                    padding: 8,
                    font: {
                        size: 10
                    }
                }
            }
        }
    }
});

// Company Distribution Chart (Stacked by Status)
const companyCtx = document.getElementById('companyChart').getContext('2d');
new Chart(companyCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.company_labels | tojson }},
        datasets: [
            {
                label: 'Not Started',
                data: {{ chart_data.company_not_started | tojson }},
                backgroundColor: '#dc3545'
            },
            {
                label: 'In Progress',
                data: {{ chart_data.company_in_progress | tojson }},
                backgroundColor: '#ffc107'
            },
            {
                label: 'Resolved',
                data: {{ chart_data.company_resolved | tojson }},
                backgroundColor: '#198754'
            },
            {
                label: 'Closed',
                data: {{ chart_data.company_closed | tojson }},
                backgroundColor: '#6c757d'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    boxWidth: 12,
                    padding: 6,
                    font: {
                        size: 9
                    }
                }
            }
        },
        scales: {
            x: {
                stacked: true,
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: {
                        size: 10
                    }
                }
            },
            y: {
                stacked: true,
                ticks: {
                    font: {
                        size: 11
                    },
                    autoSkip: false
                }
            }
        }
    }
});
</script>
{% endblock %}
