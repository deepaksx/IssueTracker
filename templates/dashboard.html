{% extends "base.html" %}

{% block title %}Dashboard - EFI IT Issue Tracker{% endblock %}

{% block content %}
<div class="dashboard-container">
<!-- Page Header -->
<div class="page-header">
    <div class="header-left">
        <div class="btn-group dashboard-toggle" role="group">
            <a href="{{ url_for('dashboard', status='Open') }}" class="btn btn-status-open {% if status_filter == 'Open' %}active{% endif %}">
                <i class="bi bi-exclamation-circle"></i> Open
            </a>
            <a href="{{ url_for('dashboard', status='In Progress') }}" class="btn btn-status-progress {% if status_filter == 'In Progress' %}active{% endif %}">
                <i class="bi bi-hourglass-split"></i> In Progress
            </a>
            <a href="{{ url_for('dashboard', status='Resolved') }}" class="btn btn-status-resolved {% if status_filter == 'Resolved' %}active{% endif %}">
                <i class="bi bi-check-circle"></i> Resolved
            </a>
            <a href="{{ url_for('dashboard', status='Closed') }}" class="btn btn-status-closed {% if status_filter == 'Closed' %}active{% endif %}">
                <i class="bi bi-x-circle"></i> Closed
            </a>
            <a href="{{ url_for('dashboard', status='') }}" class="btn btn-status-all {% if status_filter == '' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> All
            </a>
        </div>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('export_csv') }}" class="btn btn-success">
            <i class="bi bi-download"></i> Export CSV
        </a>
        {% if current_user.is_admin() or current_user.is_hod() %}
        <a href="{{ url_for('add_issue') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Issue
        </a>
        {% endif %}
    </div>
</div>

<!-- Filter Panel -->
<div class="filter-panel">
    <form method="GET" action="{{ url_for('dashboard') }}" class="row g-2">
        <div class="col-md-2">
            <label class="form-label form-label-sm">Title/Description</label>
            <input type="text" class="form-control form-control-sm" name="search" value="{{ search_query }}" placeholder="Search...">
        </div>
        <div class="col-md-1">
            <label class="form-label form-label-sm">Company</label>
            <select class="form-select form-select-sm" name="company" onchange="this.form.submit()" {% if current_user.is_hod() or current_user.is_viewer() %}disabled{% endif %}>
                {% if current_user.is_hod() or current_user.is_viewer() %}
                <option value="{{ current_user.company }}" selected>{{ current_user.company }}</option>
                {% else %}
                <option value="">All</option>
                {% for company in companies %}
                <option value="{{ company.name }}" {% if company_filter == company.name %}selected{% endif %}>{{ company.name }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label form-label-sm">Department</label>
            <select class="form-select form-select-sm" name="department" onchange="this.form.submit()" {% if current_user.is_hod() or current_user.is_viewer() %}disabled{% endif %}>
                {% if current_user.is_hod() or current_user.is_viewer() %}
                <option value="{{ current_user.department }}" selected>{{ current_user.department }}</option>
                {% else %}
                <option value="">All</option>
                {% for dept in departments %}
                <option value="{{ dept.name }}" {% if department_filter == dept.name %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label form-label-sm">Application</label>
            <select class="form-select form-select-sm" name="application" onchange="this.form.submit()">
                <option value="">All</option>
                {% for app in applications %}
                <option value="{{ app.name }}" {% if application_filter == app.name %}selected{% endif %}>{{ app.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label form-label-sm">Category</label>
            <select class="form-select form-select-sm" name="category" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="Hardware" {% if category_filter == 'Hardware' %}selected{% endif %}>Hardware</option>
                <option value="Software" {% if category_filter == 'Software' %}selected{% endif %}>Software</option>
                <option value="Network" {% if category_filter == 'Network' %}selected{% endif %}>Network</option>
                <option value="Security" {% if category_filter == 'Security' %}selected{% endif %}>Security</option>
                <option value="Other" {% if category_filter == 'Other' %}selected{% endif %}>Other</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label form-label-sm">Priority</label>
            <select class="form-select form-select-sm" name="priority" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="Low" {% if priority_filter == 'Low' %}selected{% endif %}>Low</option>
                <option value="Medium" {% if priority_filter == 'Medium' %}selected{% endif %}>Medium</option>
                <option value="High" {% if priority_filter == 'High' %}selected{% endif %}>High</option>
                <option value="Critical" {% if priority_filter == 'Critical' %}selected{% endif %}>Critical</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label form-label-sm">Status</label>
            <select class="form-select form-select-sm" name="status" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="Open" {% if status_filter == 'Open' %}selected{% endif %}>Open</option>
                <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
                <option value="Resolved" {% if status_filter == 'Resolved' %}selected{% endif %}>Resolved</option>
                <option value="Closed" {% if status_filter == 'Closed' %}selected{% endif %}>Closed</option>
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label form-label-sm">&nbsp;</label>
            <div class="d-flex gap-1">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-funnel"></i>
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm" title="Reset Filters">
                    <i class="bi bi-x-circle"></i>
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Issues Table Card -->
<div class="card issues-table-card">
    <div class="card-header">
        <span>Issues Overview</span>
        <span class="text-muted">{{ issues|length }} issue(s)</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="table-checkbox"><input type="checkbox" id="selectAll"></th>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Company</th>
                        <th>Department</th>
                        <th>Application</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if issues %}
                        {% for issue in issues %}
                        <tr>
                            <td class="table-checkbox"><input type="checkbox" class="issue-checkbox" value="{{ issue.id }}"></td>
                            <td><span class="issue-id">#{{ issue.id }}</span></td>
                            <td>
                                <a href="{{ url_for('view_issue', issue_id=issue.id) }}">
                                    {{ issue.title }}
                                </a>
                            </td>
                            <td>
                                <span class="issue-description-preview">
                                    {{ issue.description[:100] }}{% if issue.description|length > 100 %}...{% endif %}
                                </span>
                            </td>
                            <td>{{ issue.company or '-' }}</td>
                            <td>{{ issue.department or '-' }}</td>
                            <td>{{ issue.application or '-' }}</td>
                            <td>
                                <span class="badge bg-info">{{ issue.category }}</span>
                            </td>
                            <td>
                                {% if issue.priority == 'Critical' %}
                                    <span class="badge priority-critical">
                                        <i class="bi bi-flag-fill"></i> Critical
                                    </span>
                                {% elif issue.priority == 'High' %}
                                    <span class="badge priority-high">
                                        <i class="bi bi-flag-fill"></i> High
                                    </span>
                                {% elif issue.priority == 'Medium' %}
                                    <span class="badge priority-medium">
                                        <i class="bi bi-flag"></i> Medium
                                    </span>
                                {% else %}
                                    <span class="badge priority-low">
                                        <i class="bi bi-flag"></i> Low
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if issue.status == 'Open' %}
                                    <span class="badge status-open">Open</span>
                                {% elif issue.status == 'In Progress' %}
                                    <span class="badge status-progress">In Progress</span>
                                {% elif issue.status == 'Resolved' %}
                                    <span class="badge status-resolved">Resolved</span>
                                {% else %}
                                    <span class="badge status-closed">Closed</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-muted">{{ issue.created_at[:10] if issue.created_at else '-' }}</span>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('view_issue', issue_id=issue.id) }}" class="btn btn-sm btn-secondary btn-icon" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if current_user.is_admin() or current_user.is_hod() %}
                                    <a href="{{ url_for('edit_issue', issue_id=issue.id) }}" class="btn btn-sm btn-warning btn-icon" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="12" class="text-center text-muted py-4">
                                <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                <p class="mt-2">No issues found</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Select all checkbox functionality
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.issue-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});
</script>
{% endblock %}
