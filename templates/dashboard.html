{% extends "base.html" %}

{% block title %}Dashboard - EFI IT Issue Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <!-- Total Issues -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Total Issues</h6>
                        <h2 class="card-title mb-0">{{ kpi.total_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-list-ul"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Open Issues -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Open Issues</h6>
                        <h2 class="card-title mb-0">{{ kpi.open_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-exclamation-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- In Progress -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">In Progress</h6>
                        <h2 class="card-title mb-0">{{ kpi.in_progress_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resolved -->
    <div class="col-md-3">
        <div class="card kpi-card kpi-card-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Resolved</h6>
                        <h2 class="card-title mb-0">{{ kpi.resolved_issues }}</h2>
                    </div>
                    <div class="kpi-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
    <!-- Issue Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Issue Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Priority Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Priority Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="priorityChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <!-- Category Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-tags"></i> Category Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Issues by Company -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Issues by Company</h5>
            </div>
            <div class="card-body">
                <canvas id="companyChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row g-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ url_for('tracker') }}" class="btn btn-outline-primary">
                        <i class="bi bi-list-ul"></i> View All Issues
                    </a>
                    <a href="{{ url_for('tracker', status='Open') }}" class="btn btn-outline-danger">
                        <i class="bi bi-exclamation-circle"></i> View Open Issues
                    </a>
                    {% if current_user.is_admin() or current_user.is_hod() %}
                    <a href="{{ url_for('add_issue') }}" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle"></i> Add New Issue
                    </a>
                    {% endif %}
                    <a href="{{ url_for('export_csv') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.kpi-card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.kpi-card-primary {
    border-left: 4px solid #0d6efd;
}

.kpi-card-danger {
    border-left: 4px solid #dc3545;
}

.kpi-card-warning {
    border-left: 4px solid #ffc107;
}

.kpi-card-success {
    border-left: 4px solid #198754;
}

.kpi-icon {
    font-size: 2.5rem;
    opacity: 0.3;
}

.kpi-card-primary .kpi-icon {
    color: #0d6efd;
}

.kpi-card-danger .kpi-icon {
    color: #dc3545;
}

.kpi-card-warning .kpi-icon {
    color: #ffc107;
}

.kpi-card-success .kpi-icon {
    color: #198754;
}

.card-title {
    font-size: 2rem;
    font-weight: bold;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.status_labels | tojson }},
        datasets: [{
            data: {{ chart_data.status_values | tojson }},
            backgroundColor: ['#dc3545', '#ffc107', '#198754', '#6c757d']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Priority Distribution Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.priority_labels | tojson }},
        datasets: [{
            label: 'Issues',
            data: {{ chart_data.priority_values | tojson }},
            backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Category Distribution Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(categoryCtx, {
    type: 'pie',
    data: {
        labels: {{ chart_data.category_labels | tojson }},
        datasets: [{
            data: {{ chart_data.category_values | tojson }},
            backgroundColor: ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#fd7e14']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Company Distribution Chart
const companyCtx = document.getElementById('companyChart').getContext('2d');
new Chart(companyCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.company_labels | tojson }},
        datasets: [{
            label: 'Issues',
            data: {{ chart_data.company_values | tojson }},
            backgroundColor: '#0d6efd'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}
